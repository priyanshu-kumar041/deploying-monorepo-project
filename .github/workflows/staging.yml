name : Deploy a monorepo to EC2 Server

on:
    push:
        branches:
            - staging




jobs:
  deploy:
    name: deploying on ec2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the code
        uses: actions/checkout@v2

      - name: executing remote ssh commands using pub-pvt key pair
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: 3.108.40.31
          username: ubuntu
          key: ${{secrets.PRIVATE_SSH_KEY_STAGING}}
          port: 22
          script : |
            echo "logged into server"
            cd week-25-ci-necct-app
            echo "cd done"
            ssh -i ~/ssh_key root@64.227.147.124 -t "cd week-25-ci-next-app/ && git pull origin main && export PATH=/root/.nvm/versions/node/v22.13.1/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin && npm install -g pnpm && pnpm install && pnpm run build && pm2 restart fe-sever && pm2 restart http-sever && pm2 restart ws-sever"
 